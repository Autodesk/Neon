
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for project Neon">
      
      
      
        <link rel="canonical" href="https://example.com/learn/staggered-grids/staggered-grid/">
      
      
        <link rel="prev" href="../../the-bases/04-skeleton-level/">
      
      
        <link rel="next" href="../../multi-resolution/multi-resolution/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.31">
    
    
      
        <title>Staggered Grids - Neon</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Ubuntu";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#staggered-grids-experimental-wip" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Neon" class="md-header__button md-logo" aria-label="Neon" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Neon
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Staggered Grids
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="lime" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Autodesk/Neon" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Github
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Neon" class="md-nav__button md-logo" aria-label="Neon" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Neon
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Autodesk/Neon" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Github
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Neon's home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Learn
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Learn
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guided-tutorials-introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    The Bases
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            The Bases
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../the-bases/01-system-level/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    System Level
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../the-bases/02-the-set-level/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Set Level
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../the-bases/03-domain-level/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Domain Level
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../the-bases/04-skeleton-level/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Skeleton Level
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Staggered Grids
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Staggered Grids
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-0-initialization-of-a-staggered-grid" class="md-nav__link">
    <span class="md-ellipsis">
      ** Step 0 - Initialization of a staggered grid **
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-initialization-of-node-and-voxel-fields" class="md-nav__link">
    <span class="md-ellipsis">
      ** Step 1 - Initialization of node and voxel fields **
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-access-to-neighbouring-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      ** Step 2 - Access to neighbouring nodes **
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-access-to-neighbouring-voxels" class="md-nav__link">
    <span class="md-ellipsis">
      ** Step 3 - Access to neighbouring voxels **
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../multi-resolution/multi-resolution/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multi-resolution
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    References
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            References
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/papers-presentations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Papers and Presentations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/api-documentation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Documentation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/performance-considerations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Performance
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../gallery/apps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gallery
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Community
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Community
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CONTRIBUTING/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CONTRIBUTORS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributors
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../maintainers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Maintainers
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-0-initialization-of-a-staggered-grid" class="md-nav__link">
    <span class="md-ellipsis">
      ** Step 0 - Initialization of a staggered grid **
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-initialization-of-node-and-voxel-fields" class="md-nav__link">
    <span class="md-ellipsis">
      ** Step 1 - Initialization of node and voxel fields **
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-access-to-neighbouring-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      ** Step 2 - Access to neighbouring nodes **
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-access-to-neighbouring-voxels" class="md-nav__link">
    <span class="md-ellipsis">
      ** Step 3 - Access to neighbouring voxels **
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<p><img align="right" alt="" src="../../the-bases/img/03-layers-domain.png" style="width:250px" /></p>
<h1 id="staggered-grids-experimental-wip">Staggered Grids - Experimental [WIP]</h1>
<p>Staggered grids are crucial for numerical methods like the finite element method.
Neon natively provides a staggered-grid abstraction over Neon uniform grids.
In other words, we can create a staggered grid using any of the uniform grids such as dGrid (dense), eGrid (sparse),
bGrid (sparse).</p>
<p>Node Grid and Voxel Grid are Neon&rsquo;s terminology to distinguish between the primal and dual grid of a staggered
configuration.
The following image is just a 2D example of a staggered grid for a sparse uniform discrete domain; the node grid is
highlighted in blue, and the voxel grid is in green.</p>
<figure>
<p><img align="center" alt="Image title" src="../img/staggered-grid.png" width="300px" />
  </p>
<figcaption></figcaption>
</figure>
<p>Node Grid and Voxel Grid provide the same compute API that Neon uniform grids offer.
However, they also include functionality to jump from nodes to voxels and vice-versa.</p>
<p>Staggered grid provides mechanisms to create containers running on nodes or voxels.
The created containers are fully compatible with the Neon Skeleton model.</p>
<p>For this tutorial we want to showcase Neon StaggeredGrid mechanism with some simple operations,
where we represent temperature and density properties respectively on nodes and voxels.
The operations do not have actual physical meaning and their sole porpoise if to show some common type of computations
in a simple context.</p>
<ul>
<li><a href="#Initialization">** Step 0 - Initialization of a staggered grid **</a>. The StaggeredGrid initialization process is
  slightly
  different than the ones of uniform grids.
  We will be using a small 2 by 3 by 9 voxel grid.</li>
<li><a href="#Node-and-voxel-fields">** Step 1 - Initialization of node and voxel fields **</a>. We&rsquo;ll be using nodes to store
  temperature
  and voxels to store material density.</li>
<li><a href="#access-to-neighbouring-nodes-from-voxels">** Step 2 - Access to neighbouring nodes **</a>. We&rsquo;ll be looping around the
  neighbouring nodes of a voxel to sum up their temperature values.</li>
<li><a href="#access-to-neighbouring-voxels-from-nodes">** Step 3 - Access to neighbouring voxels **</a>. We&rsquo;ll be accessing
  neighbouring
  voxels of a node to sum up their density values and to divide tha result by 8.
  The division by 8 will highlight some topological characteristics of the dual grids that we can use to confirm the
  actual results.</li>
</ul>
<p>The code of the tutorial can be found in the Neon repository (<code>Neon/staggered-grid/tutorials/staggered-grids</code>).
As on the other tutorial in the rest will start from a emtpy main and we&rsquo;ll looking at how to implement the previous
steps.</p>
<p><a name="Initialization"></p>
<h2 id="step-0-initialization-of-a-staggered-grid">** Step 0 - Initialization of a staggered grid **</h2>
<p></a></p>
<p>The initialization code is straightforward. As always we first have to define the hardware configuration for the
execution by creating a <code>Backend</code> object.</p>
<p>Similarly to uniform grids, we also provide the dimension of the background grid and a
sparsity mask through a lambda function. For this last part of the process we target solely information of the voxel
grid. Thanks to the property of staggered grids, can reconstruct all the required information for the node grid.</p>
<p>Again as for the other Neon uniform grids, the last parameter is a list of stencil that will be used for computation on
the staggered grid. The stencil shape can be used either on the node and on the voxel grid.
Even with an empty stencil list, the staggered grid will include the support for stencil operation for node to
neighboring voxel and vice versa.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Neon/tutorials/staggered-grids/src/staggeredGrid.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="p">{</span><span class="c1">// Selecting the hardware for the computation</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="n">Neon</span><span class="o">::</span><span class="n">Backend</span><span class="w"> </span><span class="n">backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">        </span><span class="n">Neon</span><span class="o">::</span><span class="n">init</span><span class="p">();</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">        </span><span class="c1">// Our XPU will be a CPU device.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Neon</span><span class="o">::</span><span class="n">Runtime</span><span class="o">::</span><span class="n">openmp</span><span class="p">;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">        </span><span class="c1">// We are overbooking XPU 0 two times</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">gpu_ids</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">        </span><span class="n">Neon</span><span class="o">::</span><span class="n">Backend</span><span class="w">    </span><span class="n">backend</span><span class="p">(</span><span class="n">gpu_ids</span><span class="p">,</span><span class="w"> </span><span class="n">runtime</span><span class="p">);</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">backend</span><span class="p">;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">    </span><span class="p">}();</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">    </span><span class="c1">// Define an alias for our staggered grid</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">UniformGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Neon</span><span class="o">::</span><span class="n">domain</span><span class="o">::</span><span class="n">dGrid</span><span class="p">;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">StaggeredGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Neon</span><span class="o">::</span><span class="n">domain</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">experimental</span><span class="o">::</span><span class="n">staggeredGrid</span><span class="o">::</span><span class="n">StaggeredGrid</span><span class="o">&lt;</span><span class="n">UniformGrid</span><span class="o">&gt;</span><span class="p">;</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">FP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">double</span><span class="p">;</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">UserContainers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tools</span><span class="o">::</span><span class="n">Containers</span><span class="o">&lt;</span><span class="n">StaggeredGrid</span><span class="p">,</span><span class="w"> </span><span class="n">FP</span><span class="o">&gt;</span><span class="p">;</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">    </span><span class="c1">// Initializing a staggered grid based on dGrid</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">    </span><span class="n">StaggeredGrid</span><span class="w"> </span><span class="n">grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">        </span><span class="c1">// Setting the dimension for the voxel grid</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">        </span><span class="n">Neon</span><span class="o">::</span><span class="n">int32_3d</span><span class="w"> </span><span class="n">voxDims</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">};</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">        </span><span class="c1">// For our tutorial, we don&#39;t need to add new stencil.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">        </span><span class="c1">// By default, the staggered grid will add the stencil</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">        </span><span class="c1">// to move from voxel to node and vice versa</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Neon</span><span class="o">::</span><span class="n">domain</span><span class="o">::</span><span class="n">Stencil</span><span class="o">&gt;</span><span class="w"> </span><span class="n">noExtraStencils</span><span class="p">;</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">        </span><span class="n">StaggeredGrid</span><span class="w"> </span><span class="n">newGrid</span><span class="p">(</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">            </span><span class="n">backend</span><span class="p">,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">            </span><span class="n">voxDims</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">            </span><span class="p">[](</span><span class="k">const</span><span class="w"> </span><span class="n">Neon</span><span class="o">::</span><span class="n">index_3d</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="w">            </span><span class="p">},</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">            </span><span class="n">noExtraStencils</span><span class="p">);</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">newGrid</span><span class="p">;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="w">    </span><span class="p">}();</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><a name="Node-and-voxel-fields"></p>
<h2 id="step-1-initialization-of-node-and-voxel-fields">** Step 1 - Initialization of node and voxel fields **</h2>
<p></a></p>
<p>We now extend the previous code with the initialization of the temperature and density fields.
The process is identical to the one used for uniform grids.</p>
<p>To make the things more interesting, we used two different method to initialize the two fields.
In the density case, we used the host side interface, while for the temperature the initialization
happens on the XPU side.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The density fiels data have to manually be tranfered from the host to the XPUs, 
bacause the initilization was done on the host size.</p>
</div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Neon/tutorials/staggered-grids/src/staggeredGrid.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-1-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-1-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-1-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-1-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-1-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-1-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-1-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-1-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-1-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-1-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-1-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-1-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-1-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-1-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-1-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-1-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-1-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-1-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-1-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-1-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-1-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-1-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-1-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-1-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-1-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-1-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-1-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-1-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-1-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-1-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-1-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-1-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-1-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-1-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-1-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-1-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-1-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-1-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-1-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-1-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-1-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-1-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-1-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-1-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-1-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-1-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-1-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-1-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-1-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-1-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-1-100">100</a></span>
<span class="normal"><a href="#__codelineno-1-101">101</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-49" name="__codelineno-1-49"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-1-50" name="__codelineno-1-50"></a>
<a id="__codelineno-1-51" name="__codelineno-1-51"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">density</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">grid</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="w">        </span><span class="c1">// Defining a voxel field to represent the density of each voxel</span>
<a id="__codelineno-1-53" name="__codelineno-1-53"></a><span class="w">        </span><span class="c1">// We then set its initial values to zero in the host (CPU),</span>
<a id="__codelineno-1-54" name="__codelineno-1-54"></a><span class="w">        </span><span class="c1">// and finally we transfer the data to the XPU</span>
<a id="__codelineno-1-55" name="__codelineno-1-55"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">density</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">newVoxelField</span><span class="o">&lt;</span><span class="n">FP</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;Density&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-1-56" name="__codelineno-1-56"></a><span class="w">        </span><span class="n">density</span><span class="p">.</span><span class="n">forEachActiveCell</span><span class="p">([](</span><span class="k">const</span><span class="w"> </span><span class="n">Neon</span><span class="o">::</span><span class="n">index_3d</span><span class="o">&amp;</span><span class="w"> </span><span class="cm">/*idx*/</span><span class="p">,</span>
<a id="__codelineno-1-57" name="__codelineno-1-57"></a><span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="o">&amp;</span><span class="w"> </span><span class="cm">/*cardinality*/</span><span class="p">,</span>
<a id="__codelineno-1-58" name="__codelineno-1-58"></a><span class="w">                                     </span><span class="n">FP</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-59" name="__codelineno-1-59"></a><span class="w">            </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-1-60" name="__codelineno-1-60"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-1-61" name="__codelineno-1-61"></a><span class="w">        </span><span class="n">density</span><span class="p">.</span><span class="n">updateCompute</span><span class="p">(</span><span class="n">Neon</span><span class="o">::</span><span class="n">Backend</span><span class="o">::</span><span class="n">mainStreamIdx</span><span class="p">);</span>
<a id="__codelineno-1-62" name="__codelineno-1-62"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">density</span><span class="p">;</span>
<a id="__codelineno-1-63" name="__codelineno-1-63"></a><span class="w">    </span><span class="p">}();</span>
<a id="__codelineno-1-64" name="__codelineno-1-64"></a>
<a id="__codelineno-1-65" name="__codelineno-1-65"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">temperature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">grid</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-66" name="__codelineno-1-66"></a><span class="w">        </span><span class="c1">// Defining a node field to represent the temperature at each node</span>
<a id="__codelineno-1-67" name="__codelineno-1-67"></a><span class="w">        </span><span class="c1">// We then set its initial values to one, but to make it more interesting,</span>
<a id="__codelineno-1-68" name="__codelineno-1-68"></a><span class="w">        </span><span class="c1">// we do the initialization directly on the device calling a Containers.</span>
<a id="__codelineno-1-69" name="__codelineno-1-69"></a><span class="w">        </span><span class="c1">// Note that in this case we don&#39;t need to transfer data from host to XPUs</span>
<a id="__codelineno-1-70" name="__codelineno-1-70"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">temperature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">newNodeField</span><span class="o">&lt;</span><span class="n">FP</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;Temperature&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-1-71" name="__codelineno-1-71"></a><span class="w">        </span><span class="n">temperature</span><span class="p">.</span><span class="n">forEachActiveCell</span><span class="p">([](</span><span class="k">const</span><span class="w"> </span><span class="n">Neon</span><span class="o">::</span><span class="n">index_3d</span><span class="o">&amp;</span><span class="w"> </span><span class="cm">/*idx*/</span><span class="p">,</span>
<a id="__codelineno-1-72" name="__codelineno-1-72"></a><span class="w">                                         </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="o">&amp;</span><span class="w"> </span><span class="cm">/*cardinality*/</span><span class="p">,</span>
<a id="__codelineno-1-73" name="__codelineno-1-73"></a><span class="w">                                         </span><span class="n">FP</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-74" name="__codelineno-1-74"></a><span class="w">            </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-1-75" name="__codelineno-1-75"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-1-76" name="__codelineno-1-76"></a><span class="w">        </span><span class="n">UserContainers</span><span class="o">::</span><span class="n">resetValue</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span><span class="w"> </span><span class="n">FP</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)).</span><span class="n">run</span><span class="p">(</span><span class="n">Neon</span><span class="o">::</span><span class="n">Backend</span><span class="o">::</span><span class="n">mainStreamIdx</span><span class="p">);</span>
<a id="__codelineno-1-77" name="__codelineno-1-77"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">temperature</span><span class="p">;</span>
<a id="__codelineno-1-78" name="__codelineno-1-78"></a><span class="w">    </span><span class="p">}();</span>
<a id="__codelineno-1-79" name="__codelineno-1-79"></a>
<a id="__codelineno-1-80" name="__codelineno-1-80"></a><span class="w">    </span><span class="c1">// We define a simple function to export to vtk both</span>
<a id="__codelineno-1-81" name="__codelineno-1-81"></a><span class="w">    </span><span class="c1">// temperature and density field during each step of the tutorial.</span>
<a id="__codelineno-1-82" name="__codelineno-1-82"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">exportingToVti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">tutorialStepId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-83" name="__codelineno-1-83"></a><span class="w">        </span><span class="p">{</span><span class="w">  </span><span class="c1">// Moving memory from XPUs to CPU</span>
<a id="__codelineno-1-84" name="__codelineno-1-84"></a><span class="w">            </span><span class="n">temperature</span><span class="p">.</span><span class="n">updateIO</span><span class="p">(</span><span class="n">Neon</span><span class="o">::</span><span class="n">Backend</span><span class="o">::</span><span class="n">mainStreamIdx</span><span class="p">);</span>
<a id="__codelineno-1-85" name="__codelineno-1-85"></a><span class="w">            </span><span class="n">density</span><span class="p">.</span><span class="n">updateIO</span><span class="p">(</span><span class="n">Neon</span><span class="o">::</span><span class="n">Backend</span><span class="o">::</span><span class="n">mainStreamIdx</span><span class="p">);</span>
<a id="__codelineno-1-86" name="__codelineno-1-86"></a><span class="w">            </span><span class="n">backend</span><span class="p">.</span><span class="n">sync</span><span class="p">(</span><span class="n">Neon</span><span class="o">::</span><span class="n">Backend</span><span class="o">::</span><span class="n">mainStreamIdx</span><span class="p">);</span>
<a id="__codelineno-1-87" name="__codelineno-1-87"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-1-88" name="__codelineno-1-88"></a><span class="w">        </span><span class="p">{</span><span class="w">  </span><span class="c1">// Exporting the results</span>
<a id="__codelineno-1-89" name="__codelineno-1-89"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">appName</span><span class="p">(</span><span class="s">&quot;staggered-grid&quot;</span><span class="p">);</span>
<a id="__codelineno-1-90" name="__codelineno-1-90"></a><span class="w">            </span><span class="n">temperature</span><span class="p">.</span><span class="n">ioToVtk</span><span class="p">(</span><span class="n">appName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;-temperature-&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tutorialStepId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;temperature&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">Neon</span><span class="o">::</span><span class="n">IoFileType</span><span class="o">::</span><span class="n">BINARY</span><span class="p">);</span>
<a id="__codelineno-1-91" name="__codelineno-1-91"></a><span class="w">            </span><span class="n">density</span><span class="p">.</span><span class="n">ioToVtk</span><span class="p">(</span><span class="n">appName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;-density-&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tutorialStepId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;density&quot;</span><span class="p">);</span>
<a id="__codelineno-1-92" name="__codelineno-1-92"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-1-93" name="__codelineno-1-93"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-1-94" name="__codelineno-1-94"></a>
<a id="__codelineno-1-95" name="__codelineno-1-95"></a><span class="w">    </span><span class="c1">// We are exporting to vtk the values of the fields after the initialization.</span>
<a id="__codelineno-1-96" name="__codelineno-1-96"></a><span class="w">    </span><span class="c1">// We expect all temperature nodes to be set to one,</span>
<a id="__codelineno-1-97" name="__codelineno-1-97"></a><span class="w">    </span><span class="c1">// and all density voxels to be set to zero.</span>
<a id="__codelineno-1-98" name="__codelineno-1-98"></a><span class="w">    </span><span class="n">exportingToVti</span><span class="p">(</span><span class="s">&quot;0000&quot;</span><span class="p">);</span>
<a id="__codelineno-1-99" name="__codelineno-1-99"></a>
<a id="__codelineno-1-100" name="__codelineno-1-100"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-1-101" name="__codelineno-1-101"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The following is the code for the XPU side initialization of the temperature field shows how to
define a Neon Container on a staggered grid. The structure should result quite familiar at this point.
There are two minor changes that are highlighter in the code below.
Firstly, the method for creating a container is now specific for node and voxel grids (<code>getContainerOnNodes</code>
and <code>getContainerOnVoxel</code>). And finally, the parameter of the Neon Compute Lambda has changed
from <code>Idx</code>, to<code>Node</code> and <code>Voxel</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Neon/staggered-grid/tutorials/staggered-grids/src/containers.cu</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-40">40</a></span>
<span class="normal"><a href="#__codelineno-2-41">41</a></span>
<span class="normal"><a href="#__codelineno-2-42">42</a></span>
<span class="normal"><a href="#__codelineno-2-43">43</a></span>
<span class="normal"><a href="#__codelineno-2-44">44</a></span>
<span class="normal"><a href="#__codelineno-2-45">45</a></span>
<span class="normal"><a href="#__codelineno-2-46">46</a></span>
<span class="normal"><a href="#__codelineno-2-47">47</a></span>
<span class="normal"><a href="#__codelineno-2-48">48</a></span>
<span class="normal"><a href="#__codelineno-2-49">49</a></span>
<span class="normal"><a href="#__codelineno-2-50">50</a></span>
<span class="normal"><a href="#__codelineno-2-51">51</a></span>
<span class="normal"><a href="#__codelineno-2-52">52</a></span>
<span class="normal"><a href="#__codelineno-2-53">53</a></span>
<span class="normal"><a href="#__codelineno-2-54">54</a></span>
<span class="normal"><a href="#__codelineno-2-55">55</a></span>
<span class="normal"><a href="#__codelineno-2-56">56</a></span>
<span class="normal"><a href="#__codelineno-2-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-40" name="__codelineno-2-40"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">StaggeredGrid</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<a id="__codelineno-2-41" name="__codelineno-2-41"></a><span class="k">auto</span><span class="w"> </span><span class="n">Containers</span><span class="o">&lt;</span><span class="n">StaggeredGrid</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;::</span><span class="n">resetValue</span><span class="p">(</span><span class="n">Self</span><span class="o">::</span><span class="n">NodeField</span><span class="w">  </span><span class="n">field</span><span class="p">,</span>
<a id="__codelineno-2-42" name="__codelineno-2-42"></a><span class="w">                                              </span><span class="k">const</span><span class="w"> </span><span class="n">Self</span><span class="o">::</span><span class="n">Type</span><span class="w"> </span><span class="n">alpha</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Neon</span><span class="o">::</span><span class="n">set</span><span class="o">::</span><span class="n">Container</span>
<a id="__codelineno-2-43" name="__codelineno-2-43"></a><span class="p">{</span>
<a id="__codelineno-2-44" name="__codelineno-2-44"></a><span class="hll"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="n">getGrid</span><span class="p">().</span><span class="n">getContainerOnNodes</span><span class="p">(</span>
</span><a id="__codelineno-2-45" name="__codelineno-2-45"></a><span class="w">        </span><span class="s">&quot;addConstOnNodes&quot;</span><span class="p">,</span>
<a id="__codelineno-2-46" name="__codelineno-2-46"></a><span class="w">        </span><span class="c1">// Neon Loading Lamnbda </span>
<a id="__codelineno-2-47" name="__codelineno-2-47"></a><span class="w">        </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Neon</span><span class="o">::</span><span class="n">set</span><span class="o">::</span><span class="n">Loader</span><span class="o">&amp;</span><span class="w"> </span><span class="n">loader</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-48" name="__codelineno-2-48"></a><span class="w">            </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loader</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">field</span><span class="p">);</span>
<a id="__codelineno-2-49" name="__codelineno-2-49"></a>
<a id="__codelineno-2-50" name="__codelineno-2-50"></a><span class="w">            </span><span class="c1">// Neon Compute Lambda</span>
<a id="__codelineno-2-51" name="__codelineno-2-51"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="o">=</span><span class="p">]</span><span class="w"> </span><span class="n">NEON_CUDA_HOST_DEVICE</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Self</span><span class="o">::</span><span class="n">NodeField</span><span class="o">::</span><span class="n">Node</span><span class="o">&amp;</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="k">mutable</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-52" name="__codelineno-2-52"></a><span class="hll"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">cardinality</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><a id="__codelineno-2-53" name="__codelineno-2-53"></a><span class="w">                    </span><span class="n">out</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alpha</span><span class="p">;</span>
<a id="__codelineno-2-54" name="__codelineno-2-54"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-2-55" name="__codelineno-2-55"></a><span class="w">            </span><span class="p">};</span>
<a id="__codelineno-2-56" name="__codelineno-2-56"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-2-57" name="__codelineno-2-57"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>In the main function code, just after the field initialization we added a helper function to export Staggered grid data
to XPU. The function takes also care of moving data from XPUs to host. Again the method to export to VTK is the same as
for uniform grids. To add some variety to the tutorial, temperature fields are exported in a VTK binary format.</p>
<p>The call to the export function at the end of the previous main function code show us how the data has been initialized.
As we can see from the following screenshot, temperature nodes are al set to 1 and density voxel to zero.</p>
<p><img alt="Mapping between cells and hardware devices" src="../img/staggeredGrid-tutorial-0000.png" /></p>
<p><a name="access-to-neighbouring-nodes-from-voxels"></p>
<h2 id="step-2-access-to-neighbouring-nodes">** Step 2 - Access to neighbouring nodes **</h2>
<p></a></p>
<p>Let&rsquo;s now focus on how to do some stencil computation, we for each temperature node we want to access the value of
neighbouring density voxels.</p>
<p>We know that the in Neon the identification of a neighbour Idx of a uniform grid is done through 3D offsets.
For example if I want to identify the cell on the left (in the positive X direction), we use the 3D offset {1,0,0}.
The same abstraction is valid for stencil operation between nodes or between voxels.</p>
<p>The 3D offset abstraction is extended also to jumps between node and voxel grids as shown by the following example in
2D.</p>
<figure>
<p><img align="center" alt="Image title" src="../img/staggeredGrid-offsets.png" width="400px" />
  </p>
<figcaption></figcaption>
</figure>
<div class="admonition notes">
<p class="admonition-title">Notes</p>
<ul>
<li>In a jump beteen node and voxel grids, only the niarest neightours can be accesses (stencil of radious one). </li>
<li>The componed of a 3D offset for a grid jump are always 1 or -1, and 0 is not a valid option.</li>
<li>While the offset {1,1,1} can be both associated with a standard stencil operation and a grid jump, 
  the actual semantic is extracted by the context (i.e. the method it is called with).</li>
</ul>
</div>
<p>Now that we know how 3D offsets are formalized for the jump between primal and dual grids like in the following snipped
of code, where we create container that sums up the temperature values of the neighboring nodes and stores it in the
voxel.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Neon/tutorials/staggered-grids/src/containers.cu</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-40">40</a></span>
<span class="normal"><a href="#__codelineno-3-41">41</a></span>
<span class="normal"><a href="#__codelineno-3-42">42</a></span>
<span class="normal"><a href="#__codelineno-3-43">43</a></span>
<span class="normal"><a href="#__codelineno-3-44">44</a></span>
<span class="normal"><a href="#__codelineno-3-45">45</a></span>
<span class="normal"><a href="#__codelineno-3-46">46</a></span>
<span class="normal"><a href="#__codelineno-3-47">47</a></span>
<span class="normal"><a href="#__codelineno-3-48">48</a></span>
<span class="normal"><a href="#__codelineno-3-49">49</a></span>
<span class="normal"><a href="#__codelineno-3-50">50</a></span>
<span class="normal"><a href="#__codelineno-3-51">51</a></span>
<span class="normal"><a href="#__codelineno-3-52">52</a></span>
<span class="normal"><a href="#__codelineno-3-53">53</a></span>
<span class="normal"><a href="#__codelineno-3-54">54</a></span>
<span class="normal"><a href="#__codelineno-3-55">55</a></span>
<span class="normal"><a href="#__codelineno-3-56">56</a></span>
<span class="normal"><a href="#__codelineno-3-57">57</a></span>
<span class="normal"><a href="#__codelineno-3-58">58</a></span>
<span class="normal"><a href="#__codelineno-3-59">59</a></span>
<span class="normal"><a href="#__codelineno-3-60">60</a></span>
<span class="normal"><a href="#__codelineno-3-61">61</a></span>
<span class="normal"><a href="#__codelineno-3-62">62</a></span>
<span class="normal"><a href="#__codelineno-3-63">63</a></span>
<span class="normal"><a href="#__codelineno-3-64">64</a></span>
<span class="normal"><a href="#__codelineno-3-65">65</a></span>
<span class="normal"><a href="#__codelineno-3-66">66</a></span>
<span class="normal"><a href="#__codelineno-3-67">67</a></span>
<span class="normal"><a href="#__codelineno-3-68">68</a></span>
<span class="normal"><a href="#__codelineno-3-69">69</a></span>
<span class="normal"><a href="#__codelineno-3-70">70</a></span>
<span class="normal"><a href="#__codelineno-3-71">71</a></span>
<span class="normal"><a href="#__codelineno-3-72">72</a></span>
<span class="normal"><a href="#__codelineno-3-73">73</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-40" name="__codelineno-3-40"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">StaggeredGrid</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<a id="__codelineno-3-41" name="__codelineno-3-41"></a><span class="k">auto</span><span class="w"> </span><span class="n">Containers</span><span class="o">&lt;</span><span class="n">StaggeredGrid</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;::</span><span class="n">sumNodesOnVoxels</span><span class="p">(</span><span class="n">Self</span><span class="o">::</span><span class="n">VoxelField</span><span class="o">&amp;</span><span class="w">      </span><span class="n">densityField</span><span class="p">,</span>
<a id="__codelineno-3-42" name="__codelineno-3-42"></a><span class="w">                                                    </span><span class="k">const</span><span class="w"> </span><span class="n">Self</span><span class="o">::</span><span class="n">NodeField</span><span class="o">&amp;</span><span class="w"> </span><span class="n">temperatureField</span><span class="p">)</span>
<a id="__codelineno-3-43" name="__codelineno-3-43"></a><span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Neon</span><span class="o">::</span><span class="n">set</span><span class="o">::</span><span class="n">Container</span>
<a id="__codelineno-3-44" name="__codelineno-3-44"></a><span class="p">{</span>
<a id="__codelineno-3-45" name="__codelineno-3-45"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">densityField</span><span class="p">.</span><span class="n">getGrid</span><span class="p">().</span><span class="n">getContainerOnVoxels</span><span class="p">(</span>
<a id="__codelineno-3-46" name="__codelineno-3-46"></a><span class="w">        </span><span class="s">&quot;sumNodesOnVoxels&quot;</span><span class="p">,</span>
<a id="__codelineno-3-47" name="__codelineno-3-47"></a><span class="w">        </span><span class="c1">// Neon Loading Lambda</span>
<a id="__codelineno-3-48" name="__codelineno-3-48"></a><span class="w">        </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Neon</span><span class="o">::</span><span class="n">set</span><span class="o">::</span><span class="n">Loader</span><span class="o">&amp;</span><span class="w"> </span><span class="n">loader</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-49" name="__codelineno-3-49"></a><span class="w">            </span><span class="k">auto</span><span class="o">&amp;</span><span class="w">       </span><span class="n">density</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loader</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">densityField</span><span class="p">);</span>
<a id="__codelineno-3-50" name="__codelineno-3-50"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">temperature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loader</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">temperatureField</span><span class="p">,</span><span class="w"> </span><span class="n">Neon</span><span class="o">::</span><span class="n">Pattern</span><span class="o">::</span><span class="n">STENCIL</span><span class="p">);</span>
<a id="__codelineno-3-51" name="__codelineno-3-51"></a>
<a id="__codelineno-3-52" name="__codelineno-3-52"></a><span class="w">            </span><span class="c1">// Neon Pattern Lambda</span>
<a id="__codelineno-3-53" name="__codelineno-3-53"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="o">=</span><span class="p">]</span><span class="w"> </span><span class="n">NEON_CUDA_HOST_DEVICE</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Self</span><span class="o">::</span><span class="n">VoxelField</span><span class="o">::</span><span class="n">Voxel</span><span class="o">&amp;</span><span class="w"> </span><span class="n">voxHandle</span><span class="p">)</span><span class="w"> </span><span class="k">mutable</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-54" name="__codelineno-3-54"></a><span class="w">                </span><span class="n">Type</span><span class="w">          </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-3-55" name="__codelineno-3-55"></a><span class="w">                </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">componentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-3-56" name="__codelineno-3-56"></a>
<a id="__codelineno-3-57" name="__codelineno-3-57"></a><span class="w">                </span><span class="c1">// We visit all the neighbour nodes around voxHandle.</span>
<a id="__codelineno-3-58" name="__codelineno-3-58"></a><span class="w">                </span><span class="c1">// Relative discrete offers are used to identify the neighbour node.</span>
<a id="__codelineno-3-59" name="__codelineno-3-59"></a><span class="w">                </span><span class="c1">// As by construction all nodes of a voxel are active, we don&#39;t have to do any extra check.</span>
<a id="__codelineno-3-60" name="__codelineno-3-60"></a><span class="hll"><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">temperature</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghNodeValue</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">voxHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">);</span>
</span><a id="__codelineno-3-61" name="__codelineno-3-61"></a><span class="hll"><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">temperature</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghNodeValue</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">voxHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">);</span>
</span><a id="__codelineno-3-62" name="__codelineno-3-62"></a><span class="hll"><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">temperature</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghNodeValue</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">voxHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">);</span>
</span><a id="__codelineno-3-63" name="__codelineno-3-63"></a><span class="hll"><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">temperature</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghNodeValue</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">voxHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">);</span>
</span><a id="__codelineno-3-64" name="__codelineno-3-64"></a><span class="hll"><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">temperature</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghNodeValue</span><span class="o">&lt;</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">voxHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">);</span>
</span><a id="__codelineno-3-65" name="__codelineno-3-65"></a><span class="hll"><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">temperature</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghNodeValue</span><span class="o">&lt;</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">voxHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">);</span>
</span><a id="__codelineno-3-66" name="__codelineno-3-66"></a><span class="hll"><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">temperature</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghNodeValue</span><span class="o">&lt;</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">voxHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">);</span>
</span><a id="__codelineno-3-67" name="__codelineno-3-67"></a><span class="hll"><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">temperature</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghNodeValue</span><span class="o">&lt;</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">voxHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">);</span>
</span><a id="__codelineno-3-68" name="__codelineno-3-68"></a>
<a id="__codelineno-3-69" name="__codelineno-3-69"></a><span class="w">                </span><span class="c1">// Storing the final result in the target voxel.</span>
<a id="__codelineno-3-70" name="__codelineno-3-70"></a><span class="w">                </span><span class="n">density</span><span class="p">(</span><span class="n">voxHandle</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<a id="__codelineno-3-71" name="__codelineno-3-71"></a><span class="w">            </span><span class="p">};</span>
<a id="__codelineno-3-72" name="__codelineno-3-72"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-3-73" name="__codelineno-3-73"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Now that we now have our container, we just need to extend our main function to run it, and export the data to vti to
check the result.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Neon/tutorials/staggered-grids/src/staggeredGrid.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-71">71</a></span>
<span class="normal"><a href="#__codelineno-4-72">72</a></span>
<span class="normal"><a href="#__codelineno-4-73">73</a></span>
<span class="normal"><a href="#__codelineno-4-74">74</a></span>
<span class="normal"><a href="#__codelineno-4-75">75</a></span>
<span class="normal"><a href="#__codelineno-4-76">76</a></span>
<span class="normal"><a href="#__codelineno-4-77">77</a></span>
<span class="normal"><a href="#__codelineno-4-78">78</a></span>
<span class="normal"><a href="#__codelineno-4-79">79</a></span>
<span class="normal"><a href="#__codelineno-4-80">80</a></span>
<span class="normal"><a href="#__codelineno-4-81">81</a></span>
<span class="normal"><a href="#__codelineno-4-82">82</a></span>
<span class="normal"><a href="#__codelineno-4-83">83</a></span>
<span class="normal"><a href="#__codelineno-4-84">84</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-71" name="__codelineno-4-71"></a><span class="w">    </span><span class="c1">// ... </span>
<a id="__codelineno-4-72" name="__codelineno-4-72"></a>
<a id="__codelineno-4-73" name="__codelineno-4-73"></a><span class="w">    </span><span class="p">{</span><span class="w">  </span><span class="c1">// Accessing voxels from nodes</span>
<a id="__codelineno-4-74" name="__codelineno-4-74"></a><span class="w">       </span><span class="c1">// For each node we loop around active voxel, and we sum their values.</span>
<a id="__codelineno-4-75" name="__codelineno-4-75"></a><span class="w">       </span><span class="c1">// At the end of this operation we expect all voxel to store a value of 8,</span>
<a id="__codelineno-4-76" name="__codelineno-4-76"></a><span class="w">       </span><span class="c1">// as there are 8 nodes for each voxel, each one set to one.</span>
<a id="__codelineno-4-77" name="__codelineno-4-77"></a><span class="w">        </span><span class="n">UserContainers</span><span class="o">::</span><span class="n">sumNodesOnVoxels</span><span class="p">(</span><span class="n">density</span><span class="p">,</span><span class="w"> </span><span class="n">temperature</span><span class="p">)</span>
<a id="__codelineno-4-78" name="__codelineno-4-78"></a><span class="w">            </span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">Neon</span><span class="o">::</span><span class="n">Backend</span><span class="o">::</span><span class="n">mainStreamIdx</span><span class="p">);</span>
<a id="__codelineno-4-79" name="__codelineno-4-79"></a>
<a id="__codelineno-4-80" name="__codelineno-4-80"></a><span class="w">        </span><span class="n">exportingToVti</span><span class="p">(</span><span class="s">&quot;0001&quot;</span><span class="p">);</span>
<a id="__codelineno-4-81" name="__codelineno-4-81"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-82" name="__codelineno-4-82"></a>
<a id="__codelineno-4-83" name="__codelineno-4-83"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-84" name="__codelineno-4-84"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code>sumNodesOnVoxels</code> Container represents a stencil opertation, therefore the halo of the temperature field must be up to 
date before executing the container.
There are two wasy for addressing this, we can update the halo manually (as in the tutorial code) or we can use the Skeleton.
In this tutorial we choose the first solution as we are showcasing mechanisms at the Domain level. Finally, the 
halo update code is in the tutorial code but has not reported here as it is not the focus out topic: Staggered grids.</p>
</div>
<p>The resulting visualization of the results is not exciting, but it conforms that it confirms that the code is working:
all temperature nodes are still set to one as in the initialization step while all density voxel are now set to 8.
This is exactly the result we were expecting as each voxel is surrounded by exactly 8 voxels.</p>
<p><img alt="Mapping between cells and hardware devices" src="../img/staggeredGrid-tutorial-0001.png" /></p>
<p><a name="access-to-neighbouring-voxels-from-nodes"></p>
<h2 id="step-3-access-to-neighbouring-voxels">** Step 3 - Access to neighbouring voxels **</h2>
<p></a></p>
<p>In this last step we implement a container that given a nodes it fetches values from all the neighbouring density
voxels, sum them up, and it finally stores one with of the sum into the node temperature value.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Neon/tutorials/staggered-grids/src/containers.cu</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-49">49</a></span>
<span class="normal"><a href="#__codelineno-5-50">50</a></span>
<span class="normal"><a href="#__codelineno-5-51">51</a></span>
<span class="normal"><a href="#__codelineno-5-52">52</a></span>
<span class="normal"><a href="#__codelineno-5-53">53</a></span>
<span class="normal"><a href="#__codelineno-5-54">54</a></span>
<span class="normal"><a href="#__codelineno-5-55">55</a></span>
<span class="normal"><a href="#__codelineno-5-56">56</a></span>
<span class="normal"><a href="#__codelineno-5-57">57</a></span>
<span class="normal"><a href="#__codelineno-5-58">58</a></span>
<span class="normal"><a href="#__codelineno-5-59">59</a></span>
<span class="normal"><a href="#__codelineno-5-60">60</a></span>
<span class="normal"><a href="#__codelineno-5-61">61</a></span>
<span class="normal"><a href="#__codelineno-5-62">62</a></span>
<span class="normal"><a href="#__codelineno-5-63">63</a></span>
<span class="normal"><a href="#__codelineno-5-64">64</a></span>
<span class="normal"><a href="#__codelineno-5-65">65</a></span>
<span class="normal"><a href="#__codelineno-5-66">66</a></span>
<span class="normal"><a href="#__codelineno-5-67">67</a></span>
<span class="normal"><a href="#__codelineno-5-68">68</a></span>
<span class="normal"><a href="#__codelineno-5-69">69</a></span>
<span class="normal"><a href="#__codelineno-5-70">70</a></span>
<span class="normal"><a href="#__codelineno-5-71">71</a></span>
<span class="normal"><a href="#__codelineno-5-72">72</a></span>
<span class="normal"><a href="#__codelineno-5-73">73</a></span>
<span class="normal"><a href="#__codelineno-5-74">74</a></span>
<span class="normal"><a href="#__codelineno-5-75">75</a></span>
<span class="normal"><a href="#__codelineno-5-76">76</a></span>
<span class="normal"><a href="#__codelineno-5-77">77</a></span>
<span class="normal"><a href="#__codelineno-5-78">78</a></span>
<span class="normal"><a href="#__codelineno-5-79">79</a></span>
<span class="normal"><a href="#__codelineno-5-80">80</a></span>
<span class="normal"><a href="#__codelineno-5-81">81</a></span>
<span class="normal"><a href="#__codelineno-5-82">82</a></span>
<span class="normal"><a href="#__codelineno-5-83">83</a></span>
<span class="normal"><a href="#__codelineno-5-84">84</a></span>
<span class="normal"><a href="#__codelineno-5-85">85</a></span>
<span class="normal"><a href="#__codelineno-5-86">86</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-49" name="__codelineno-5-49"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">StaggeredGrid</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<a id="__codelineno-5-50" name="__codelineno-5-50"></a><span class="k">auto</span><span class="w"> </span><span class="n">Containers</span><span class="o">&lt;</span><span class="n">StaggeredGrid</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;::</span><span class="n">sumVoxelsOnNodesAndDivideBy8</span><span class="p">(</span><span class="n">Self</span><span class="o">::</span><span class="n">NodeField</span><span class="o">&amp;</span><span class="w">        </span><span class="n">temperatureField</span><span class="p">,</span>
<a id="__codelineno-5-51" name="__codelineno-5-51"></a><span class="w">                                                                </span><span class="k">const</span><span class="w"> </span><span class="n">Self</span><span class="o">::</span><span class="n">VoxelField</span><span class="o">&amp;</span><span class="w"> </span><span class="n">densityField</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Neon</span><span class="o">::</span><span class="n">set</span><span class="o">::</span><span class="n">Container</span>
<a id="__codelineno-5-52" name="__codelineno-5-52"></a><span class="p">{</span>
<a id="__codelineno-5-53" name="__codelineno-5-53"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">temperatureField</span><span class="p">.</span><span class="n">getGrid</span><span class="p">().</span><span class="n">getContainerOnNodes</span><span class="p">(</span>
<a id="__codelineno-5-54" name="__codelineno-5-54"></a><span class="w">        </span><span class="s">&quot;sumVoxelsOnNodesAndDivideBy8&quot;</span><span class="p">,</span>
<a id="__codelineno-5-55" name="__codelineno-5-55"></a><span class="w">        </span><span class="c1">// Neon Loading Lambda</span>
<a id="__codelineno-5-56" name="__codelineno-5-56"></a><span class="w">        </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Neon</span><span class="o">::</span><span class="n">set</span><span class="o">::</span><span class="n">Loader</span><span class="o">&amp;</span><span class="w"> </span><span class="n">loader</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-57" name="__codelineno-5-57"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">density</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loader</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">densityField</span><span class="p">,</span><span class="w"> </span><span class="n">Neon</span><span class="o">::</span><span class="n">Pattern</span><span class="o">::</span><span class="n">STENCIL</span><span class="p">);</span>
<a id="__codelineno-5-58" name="__codelineno-5-58"></a><span class="w">            </span><span class="k">auto</span><span class="o">&amp;</span><span class="w">       </span><span class="n">temperature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loader</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">temperatureField</span><span class="p">);</span>
<a id="__codelineno-5-59" name="__codelineno-5-59"></a>
<a id="__codelineno-5-60" name="__codelineno-5-60"></a><span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">nodeSpaceDim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temperatureField</span><span class="p">.</span><span class="n">getGrid</span><span class="p">().</span><span class="n">getDimension</span><span class="p">();</span>
<a id="__codelineno-5-61" name="__codelineno-5-61"></a>
<a id="__codelineno-5-62" name="__codelineno-5-62"></a><span class="w">            </span><span class="c1">// Neon Pattern Lambda</span>
<a id="__codelineno-5-63" name="__codelineno-5-63"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="o">=</span><span class="p">]</span><span class="w"> </span><span class="n">NEON_CUDA_HOST_DEVICE</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Self</span><span class="o">::</span><span class="n">NodeField</span><span class="o">::</span><span class="n">Node</span><span class="o">&amp;</span><span class="w"> </span><span class="n">nodeHandle</span><span class="p">)</span><span class="w"> </span><span class="k">mutable</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-64" name="__codelineno-5-64"></a><span class="w">                </span><span class="n">Type</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-5-65" name="__codelineno-5-65"></a>
<a id="__codelineno-5-66" name="__codelineno-5-66"></a><span class="w">                </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">componentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-5-67" name="__codelineno-5-67"></a><span class="w">                </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">returnValueIfVoxelIsNotActive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-5-68" name="__codelineno-5-68"></a>
<a id="__codelineno-5-69" name="__codelineno-5-69"></a><span class="w">                </span><span class="c1">// We visit all the neighbouring voxels around nodeHandle.</span>
<a id="__codelineno-5-70" name="__codelineno-5-70"></a><span class="w">                </span><span class="c1">// Relative discrete offers are used to identify the neighbour node.</span>
<a id="__codelineno-5-71" name="__codelineno-5-71"></a><span class="w">                </span><span class="c1">// Note that some neighbouring nodes may be not active.</span>
<a id="__codelineno-5-72" name="__codelineno-5-72"></a><span class="w">                </span><span class="c1">// Rather than explicitly checking we ask Neon to return 0 if the node is not active.</span>
<a id="__codelineno-5-73" name="__codelineno-5-73"></a><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">density</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghVoxelValue</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nodeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">,</span><span class="w"> </span><span class="n">returnValueIfVoxelIsNotActive</span><span class="p">).</span><span class="n">value</span><span class="p">;</span>
<a id="__codelineno-5-74" name="__codelineno-5-74"></a><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">density</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghVoxelValue</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nodeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">,</span><span class="w"> </span><span class="n">returnValueIfVoxelIsNotActive</span><span class="p">).</span><span class="n">value</span><span class="p">;</span>
<a id="__codelineno-5-75" name="__codelineno-5-75"></a><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">density</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghVoxelValue</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nodeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">,</span><span class="w"> </span><span class="n">returnValueIfVoxelIsNotActive</span><span class="p">).</span><span class="n">value</span><span class="p">;</span>
<a id="__codelineno-5-76" name="__codelineno-5-76"></a><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">density</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghVoxelValue</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nodeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">,</span><span class="w"> </span><span class="n">returnValueIfVoxelIsNotActive</span><span class="p">).</span><span class="n">value</span><span class="p">;</span>
<a id="__codelineno-5-77" name="__codelineno-5-77"></a><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">density</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghVoxelValue</span><span class="o">&lt;</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nodeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">,</span><span class="w"> </span><span class="n">returnValueIfVoxelIsNotActive</span><span class="p">).</span><span class="n">value</span><span class="p">;</span>
<a id="__codelineno-5-78" name="__codelineno-5-78"></a><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">density</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghVoxelValue</span><span class="o">&lt;</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nodeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">,</span><span class="w"> </span><span class="n">returnValueIfVoxelIsNotActive</span><span class="p">).</span><span class="n">value</span><span class="p">;</span>
<a id="__codelineno-5-79" name="__codelineno-5-79"></a><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">density</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghVoxelValue</span><span class="o">&lt;</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nodeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">,</span><span class="w"> </span><span class="n">returnValueIfVoxelIsNotActive</span><span class="p">).</span><span class="n">value</span><span class="p">;</span>
<a id="__codelineno-5-80" name="__codelineno-5-80"></a><span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">density</span><span class="p">.</span><span class="k">template</span><span class="w"> </span><span class="n">getNghVoxelValue</span><span class="o">&lt;</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nodeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">componentId</span><span class="p">,</span><span class="w"> </span><span class="n">returnValueIfVoxelIsNotActive</span><span class="p">).</span><span class="n">value</span><span class="p">;</span>
<a id="__codelineno-5-81" name="__codelineno-5-81"></a>
<a id="__codelineno-5-82" name="__codelineno-5-82"></a><span class="w">                </span><span class="c1">// Storing the final result in the target node.</span>
<a id="__codelineno-5-83" name="__codelineno-5-83"></a><span class="w">                </span><span class="n">temperature</span><span class="p">(</span><span class="n">nodeHandle</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="__codelineno-5-84" name="__codelineno-5-84"></a><span class="w">            </span><span class="p">};</span>
<a id="__codelineno-5-85" name="__codelineno-5-85"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-5-86" name="__codelineno-5-86"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The structure of the above Container is the similar to the previous one. However <code>getNghVoxelValue</code> has a different
signature. Indeed, while all nodes of a voxel are active by construction, the same is not true for the neighbouring
voxels of a node. Therefore <code>getNghVoxelValue</code> returns a structure that contains both the value of the neighbour node
field and an active flag.</p>
<p>Instead, explicitly checking if the neighbour voxel is active or not, we use the parameter of getNghVoxelValue, which
define value returned by the method for non-active voxels. We set the parameter to
zero (<code>returnValueIfVoxelIsNotActive</code>), which is the neutral element of the sum operator.</p>
<p>The final thing to is to run our new Container from the main function and export the resulting data to vtk as shown
below.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Neon/tutorials/staggered-grids/src/staggeredGrid.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-49">49</a></span>
<span class="normal"><a href="#__codelineno-6-50">50</a></span>
<span class="normal"><a href="#__codelineno-6-51">51</a></span>
<span class="normal"><a href="#__codelineno-6-52">52</a></span>
<span class="normal"><a href="#__codelineno-6-53">53</a></span>
<span class="normal"><a href="#__codelineno-6-54">54</a></span>
<span class="normal"><a href="#__codelineno-6-55">55</a></span>
<span class="normal"><a href="#__codelineno-6-56">56</a></span>
<span class="normal"><a href="#__codelineno-6-57">57</a></span>
<span class="normal"><a href="#__codelineno-6-58">58</a></span>
<span class="normal"><a href="#__codelineno-6-59">59</a></span>
<span class="normal"><a href="#__codelineno-6-60">60</a></span>
<span class="normal"><a href="#__codelineno-6-61">61</a></span>
<span class="normal"><a href="#__codelineno-6-62">62</a></span>
<span class="normal"><a href="#__codelineno-6-63">63</a></span>
<span class="normal"><a href="#__codelineno-6-64">64</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-49" name="__codelineno-6-49"></a><span class="w">    </span><span class="p">{</span><span class="w">  </span><span class="c1">// Accessing nodes from voxels</span>
<a id="__codelineno-6-50" name="__codelineno-6-50"></a><span class="w">       </span><span class="c1">// For each voxel we loop around all nodes, we sum their values and divide the result by 8.</span>
<a id="__codelineno-6-51" name="__codelineno-6-51"></a><span class="w">       </span><span class="c1">// At the end of the container we expect to have the following values:</span>
<a id="__codelineno-6-52" name="__codelineno-6-52"></a><span class="w">       </span><span class="c1">// -- 1 for any corner node</span>
<a id="__codelineno-6-53" name="__codelineno-6-53"></a><span class="w">       </span><span class="c1">// -- 2 for any node on an edge of our domain</span>
<a id="__codelineno-6-54" name="__codelineno-6-54"></a><span class="w">       </span><span class="c1">// -- 3 for any node on a face</span>
<a id="__codelineno-6-55" name="__codelineno-6-55"></a><span class="w">       </span><span class="c1">// -- 4 for internal nodes</span>
<a id="__codelineno-6-56" name="__codelineno-6-56"></a><span class="w">        </span><span class="n">UserContainers</span><span class="o">::</span><span class="n">sumVoxelsOnNodesAndDivideBy8</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span>
<a id="__codelineno-6-57" name="__codelineno-6-57"></a><span class="w">                                                     </span><span class="n">density</span><span class="p">)</span>
<a id="__codelineno-6-58" name="__codelineno-6-58"></a><span class="w">            </span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">Neon</span><span class="o">::</span><span class="n">Backend</span><span class="o">::</span><span class="n">mainStreamIdx</span><span class="p">);</span>
<a id="__codelineno-6-59" name="__codelineno-6-59"></a>
<a id="__codelineno-6-60" name="__codelineno-6-60"></a><span class="w">        </span><span class="n">exportingToVti</span><span class="p">(</span><span class="s">&quot;0002&quot;</span><span class="p">);</span>
<a id="__codelineno-6-61" name="__codelineno-6-61"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-62" name="__codelineno-6-62"></a>
<a id="__codelineno-6-63" name="__codelineno-6-63"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-6-64" name="__codelineno-6-64"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code>sumVoxelsOnNodesAndDivideBy8</code> Container represents a stencil opertation, therefore the halo of the temperature field must be up to 
date before executing the container.</p>
</div>
<p><img alt="Mapping between cells and hardware devices" src="../img/staggeredGrid-tutorial-0002.png" /></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>